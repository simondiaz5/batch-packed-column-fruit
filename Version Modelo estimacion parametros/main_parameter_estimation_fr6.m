%% main_parameter_estimation_Fr
clear all
clc
close all
%% Condiciones iniciales
load('X0_ini_ev') %% 6/7/2018 20:06 cond_inicialx0.m % Cmet=1.5; % V=40; % GA=13; % N=21;
load('destilaciones_fr_step2')



%% Setting initial condition vector
x0_ini2=x0_ini;
N=7;
No=6;  %ecuaciones externas BMyE columna  
x0_ini=zeros(4*N+No,1);
x0_ini(1)=x0_ini2(1);
x0_ini(2)=x0_ini2(2);
x0_ini(3)=x0_ini2(3);
for J=1:N
  x0_ini(4*J+0)=(x0_ini2(4*J+0+8*(J-1))+x0_ini2(4*J+4+8*(J-1))+x0_ini2(4*J+8+8*(J-1)))/3;
  x0_ini(4*J+1)=(x0_ini2(4*J+1+8*(J-1))+x0_ini2(4*J+5+8*(J-1))+x0_ini2(4*J+9+8*(J-1)))/3+0.01;
  x0_ini(4*J+2)=(x0_ini2(4*J+2+8*(J-1))+x0_ini2(4*J+6+8*(J-1))+x0_ini2(4*J+10+8*(J-1)))/3;
  x0_ini(4*J+3)=(x0_ini2(4*J+3+8*(J-1))+x0_ini2(4*J+7+8*(J-1))+x0_ini2(4*J+11+8*(J-1)))/3;
end

b=2;
a=1;
x_min=[1767.71545621850;0.00799041062661984;3.41060000832915e-05;0.740207193810922;0.00799041062661984;3.41060000832915e-05;352.310691243690;0.740207193810922;0.00799041062661984;3.41060000832915e-05;352.310691243690;0.740207193810922;0.00799041062661984;3.41060000832915e-05;352.310691243690;0.740207193810922;0.00799041062661984;3.41060000832915e-05;352.310691243690;0.740207193810922;0.00799041062661984;3.41060000832915e-05;352.310691243690;0.740207193810922;0.00799041062661984;3.41060000832915e-05;352.310691243690;0.740207193810922;0.00799041062661984;3.41060000832915e-05;352.310691243690;0;0;0];
x_max=[2018.07587071285;0.624753322576231;0.000637824871562298;1.30537895369255;0.624753322576231;0.000637824871562298;371.461866693347;1.30537895369255;0.624753322576231;0.000637824871562298;371.461866693347;1.30537895369255;0.624753322576231;0.000637824871562298;371.461866693347;1.30537895369255;0.624753322576231;0.000637824871562298;371.461866693347;1.30537895369255;0.624753322576231;0.000637824871562298;371.461866693347;1.30537895369255;0.624753322576231;0.000637824871562298;371.461866693347;1.30537895369255;0.624753322576231;0.000637824871562298;371.461866693347;65.8799169826809;0.143158013086597;184.381691331991];
x_range=[250.360414494350;0.616762911949612;0.000603718871479006;0.565171759881627;0.616762911949612;0.000603718871479006;19.1511754496572;0.565171759881627;0.616762911949612;0.000603718871479006;19.1511754496572;0.565171759881627;0.616762911949612;0.000603718871479006;19.1511754496572;0.565171759881627;0.616762911949612;0.000603718871479006;19.1511754496572;0.565171759881627;0.616762911949612;0.000603718871479006;19.1511754496572;0.565171759881627;0.616762911949612;0.000603718871479006;19.1511754496572;0.565171759881627;0.616762911949612;0.000603718871479006;19.1511754496572;65.8799169826809;0.143158013086597;184.381691331991];
x_ss=0.5*(x_max+x_min);

%Ajuste de estados auxiliares
x0_ini(4*N+3+1:4*N+No-1)=0;  % estados auxiliares 

ini_ode.x0_ini=x0_ini;
ini_ode.a=a;
ini_ode.b=b;
ini_ode.x_range=x_range;
ini_ode.x_ss=x_ss;

%% Test
% Mcp_c=4;
% Phi_ef=0.70;
% Eff_area=0.355;  %mL volumen
% Q_loss=15; % watt
% p=[Mcp_c Phi_ef Eff_area Q_loss];
% test_parameter_fcost(p)

%% Global Optimization
tic()
% Resultados 2refinando 1800 (ub 30 y 0.055)  / Max eval 20 / ndiverse 4 /
% x0 res 1
% p_opt=[5.870098814691025,0.945974882169374,0.299225083008035,27.136162871996120,0.049183081954976];

% Resultados 1 primera 1575 seg (ub 25 y 0.05)   / Max eval 10 / ndiverse 4 
% x0 res 2
% p_opt=[5.99109584947065,0.940876045345408,0.294413959280291,22.2740189203686,0.0497364205218805];

%========================= PROBLEM SPECIFICATIONS ===========================
problem.f='fcost_Fr6';                               %mfile containing the objective function
% problem.x_L=[0.5 0.1 0.2    0 0.039604473495884];                      %lower bounds 
problem.x_L=[0.5 0.1 0.15    0, 0.039604473495884 1800];                      %lower bounds 
% problem.x_U=[6    1   1    25 0.05];                         %upper bounds 1
problem.x_U=[10    1   1    40 0.055 2500];                         %upper bounds
% problem.x_0=[4   0.7 0.355 15 0.039604473495884]; % x0 para 1
% problem.x_0=[5.99109584947065,0.940876045345408,0.294413959280291,22.2740189203686,0.0497364205218805]; % x0 para 2
problem.x_0=[5.99109584947065,0.940876045345408,0.294413959280291,22.2740189203686,0.0497364205218805 2018]; % x0 para 3



opts.maxeval=150;  %500
opts.ndiverse=20;  % 40

% opts.local.use_gradient_for_finish = 1; %DW: provide gradient to fmincon
% opts.local.check_gradient_for_finish = 1; %DW: gradient checker
opts.local.solver='fmincon';
opts.local.finish='fmincon';
opts.local.iterprint=1;
x_opt=zeros(4,6);
%========================= END OF PROBLEM SPECIFICATIONS =====================
for i=1:4
Results=MEIGO(problem,opts,'ESS',destilaciones3,ini_ode,i);
x_opt(i,:)=Results.xbest;
end
% save results.mat
toc()
% index_140=[2 4];  % 1 y 3 malo
% index_200=[5 7];  % 6 malo
% index_250=[8 9];  % 10 malo
test_parameter_fcost6(x_opt)




